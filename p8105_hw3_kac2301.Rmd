---
title: "p8105_hw3_kac2301"
author: "Kate Colvin"
output: github_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggridges)
library(patchwork)

```

## Question 1

```{r}

library(p8105.datasets)
data("ny_noaa")
head(ny_noaa)

```

This dataset has 7 columns and 2,595,176 rows. Some important variables are date, precipitation (mm), snowfall (mm), and snow depth (mm). Missing data seems to be a very large problem in this dataset, with precipitation, snowfall, snow depth, and especially the minimum and maximum temperature having a large fraction of entries missing. 

Data cleaning, separating date into year, month, and day: 

```{r}

ny_noaa <- ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))

head(ny_noaa)

```

Finding the most commonly observed values for snowfall: 

```{r}

ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n)) %>% 
  head()

```

The most commonly observed value for snowfall is 0, which makes sense since it doesn't snow for most of the year in New York.  

Making a two-panel plot of the average max temperature in January and in July in each station across years: 

```{r}

ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + 
  geom_point() + 
  facet_grid(~month)

```

With so many data points, it's hard to make out much of a structure in the above plots. The mean maximum temperature in January is always much lower than July, which makes sense given the seasons. There are a few outliers in each month, with the greatest outlier being a very cold station in July of 1988. 

Making a two-panel plot showing tmax vs tmin + the distribution of snowfall values greater than 0 and less than 100, by year:

```{r}

plot_i <- ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex() + 
  theme_minimal()

plot_ii <- ny_noaa %>% 
  filter(snow > 0, snow < 100) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges() +
  theme_minimal()

plot_i + plot_ii

```



## Question 2

Loading in data, cleaning names and renaming variables, creating merged dataframe:

```{r}

accel_df <- read_csv("data/nhanes_accel.csv") %>% 
  janitor::clean_names()

covar_df <- read_csv("data/nhanes_covar.csv", skip = 4)
names(covar_df) <- c("seqn", "sex", "age", "bmi", "education")
covar_df <- covar_df %>% 
  mutate(sex = 
           case_match(
             sex, 
             1 ~ "male",
             2 ~ "female"), 
         education = 
           case_match(
             education,
             1 ~ "Less than high school", 
             2 ~ "High school equivalent", 
             3 ~ "More than high school"), 
         seqn = as.double(seqn), 
         age = as.integer(age))


# merging tables, filtering variable values that we want into final dataset

nhanes_df <- left_join(covar_df, accel_df, by = "seqn") %>% 
  arrange(seqn) %>% 
  filter(age >= 21) %>% 
  drop_na() %>% 
  mutate(bmi = as.double(bmi), 
         education = factor(education, 
                            ordered = TRUE, 
                            levels = c("Less than high school", 
                                       "High school equivalent", 
                                       "More than high school")))
head(nhanes_df)

```

Creating long form table:

```{r}

nhanes_df_longer <- nhanes_df %>% 
  pivot_longer(min1:min1440, 
               names_to = "minute_number", 
               values_to = "mims", 
               names_prefix = "min") %>% 
  mutate(minute_number = as.integer(minute_number))

head(nhanes_df_longer)

```

Creating table for the number of men and women in each education category:

```{r}

nhanes_df %>% group_by(education, sex) %>% 
  summarize(count = n())

```

Looking at the above table, the count of men and women in each education level seems roughly equivalent, except that many more men have a high school equivalent level of education. 

Creating visualization of the age distributions for men and women in each education category:

```{r}

nhanes_df %>% ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.4) +
  facet_grid(~education) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  ylim(0, 0.03)

```

Looking at the above plots, it's immediately obvious that most of the people with an education beyond high school are young men and women (people under 40 years old), and are generally primarily women. Looking at the lower two education categories, it seems like the people with less than a high school degree are primarily middle-aged and older (older than 45), and that people with a high school equivalent are split by age and by gender. Most of the people with a high school equivalent who are older than 50 are women, while the people who are younger are mostly men. 

Aggregating across minutes to create a total activity variable for each participant:

```{r}

nhanes_df <- nhanes_df %>% 
  group_by(seqn) %>% 
  mutate(
    total_activity = sum(c_across(min1:min1440)))

```

Creating plot of total activities vs. age:

```{r}

nhanes_df %>% ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point() +
  facet_grid(~education) + 
  theme(legend.position = "bottom") +
  geom_smooth(se = FALSE)

```

For all education levels and genders, total activity goes down with age. Interestingly, for people with less than a high school degree, they start with a much higher level of physical activity than the other two education levels, but eventually does decline to about the same level. People with more than a high school degree have the most consistent total activity levels across age compared to the other two education categories. 

Creating plots of the 24-hour activity time courses for each education level:

```{r}

# Non-aggregated plots

nhanes_df_longer %>% ggplot(aes(x = minute_number, y = mims, color = sex)) + 
  geom_line(size = 0.1, alpha = 0.3) + 
  facet_grid(~education) + 
  geom_smooth() + 
  theme(legend.position = "bottom")

```

Creating a clearer plot with MIMS averaged by gender for each minute:

```{r}

# aggregated plots

nhanes_df_longer %>% group_by(minute_number, sex, education) %>% 
  summarize(
    mims_sum = mean(mims)) %>% 
  ggplot(aes(x = minute_number, y = mims_sum, color = sex)) + 
  geom_line(alpha = 0.5) + 
  facet_grid(~education) + 
  geom_smooth() + 
  theme(legend.position = "bottom")

```

Looking at the plots above, it's clear that there is large variance in the amount of physical activity people are getting based on the MIMS measurement. One interesting finding is that the difference in physical activity between men and women increases with education level. Specifically, women become more active than men at higher education levels. Additionally, it's interesting that the area with the lowest amount of physical activity in each graph is very narrow, indicating that theres only an hour or two where most people are sleeping/resting at around 4AM.



## Question 3

Loading in, cleaning, and merging datasets:

```{r}

jan2020_df <- read_csv("data/citibike/Jan 2020 Citi.csv") %>% 
  mutate(year = 2020, month = "January")

july2020_df <- read_csv("data/citibike/July 2020 Citi.csv") %>% 
  mutate(year = 2020, month = "July")

jan2024_df <- read_csv("data/citibike/Jan 2024 Citi.csv") %>% 
  mutate(year = 2024, month = "January")

july2024_df <- read_csv("data/citibike/July 2024 Citi.csv") %>% 
  mutate(year = 2024, month = "July")

# Merging into one table

citi_df <- bind_rows(jan2020_df, july2020_df, jan2024_df, july2024_df) %>% 
    select(ride_id, rideable_type, duration, weekdays, month, 
         year, start_station_name, end_station_name, member_casual)

head(citi_df)

```

The final merged data set above has 9 columns and 99,485 rows. Each row represents a ride on a Citi Bike. Some of the important variables are duration (minutes), weekdays, month, year, and member_casual (rider status as a member or not). 

Creating table of the total number of rides in each combination of year and month, separating casual riders and members:

```{r}

citi_df %>% group_by(year, month, member_casual) %>% 
  summarize(
    count = n()) %>% 
  arrange(member_casual)

```

Looking at the table above, we can see that Citi Bike usage has increased over time for both casual and member riders. For most months, there were many more rides by members than by casual riders, but this gap has narrowed moving forward in time. 

Creating a table showing the 5 most popular starting stations for July 2024:

```{r}

july2024_df %>% 
  group_by(start_station_name) %>% 
  summarize(ride_count = n()) %>% 
  arrange(desc(ride_count)) %>% 
  head(5)

```

Creating a plot to see the effects of the day of the week, month, and year on median ride duration: 

```{r}

citi_df %>% 
  group_by(weekdays, month, year) %>% 
  summarize(median_ride_duration = median(duration)) %>% 
  mutate(
    weekdays = factor(weekdays, 
                      ordered = TRUE, 
                      levels = c("Sunday", "Monday", "Tuesday", "Wednesday", 
                                 "Thursday", "Friday", "Saturday"))) %>% 
  ggplot(aes(x = weekdays, y = median_ride_duration, color = month)) +
  geom_point() + 
  facet_grid(~year) + 
  theme(legend.position = "bottom") + 
  scale_x_discrete(guide = guide_axis(angle = 90))

```

Looking at the scatter plot above, it seems like median ride duration is typically much higher on the weekends for most months and years (with the exception being January 2024, which had a very low median ride duration on Sundays). We can also see that median ride duration was always higher in July than in January for everyday of the week for both years, which makes sense since it's probably a lot more pleasant to bike in the Summer than in Winter. Overall, the median ride durations for both months in 2024 were much lower than the median ride durations in 2020, which I thought was really interesting. It could be that as Citi Bikes became more popular, people started using them more for quick errands or short commutes, instead of taking them on just long bike rides as an activity in itself. 

Creating a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration in 2024: 

```{r}

citi_df %>% 
  filter(year == 2024) %>% 
  ggplot(aes(x = duration, fill = rideable_type)) +
  geom_density(alpha = 0.5) +
  facet_grid(member_casual~month) + 
  theme(legend.position = "bottom")

```

Looking at the plots above, we can see that for every combination of month, membership, and vehicle type, the distribution of ride duration is very right-skewed, with the vast majority of rides being under 50 minutes. Between classic bikes and electric bikes, the difference in duration is relatively minimal, but more pronounced in casual bikers than in members, with classic bikes having a slightly flatter distribution with more longer rides (but only very slightly). The distributions between January and July look very similar, with the July rides being slightly flatter (more rides with a slightly longer duration), which would make sense given that it is probably much nicer to bike in the warm July weather than in the Winter. 
